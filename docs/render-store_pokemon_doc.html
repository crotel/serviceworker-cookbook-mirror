<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1.0, user-scalable=yes">
  
  <title>Render Store Recipe - Performance - ServiceWorker Cookbook</title>
  
  <link rel="shortcut icon" href="favicon.ico" type="image/x-icon">
  <link rel="stylesheet" href="tabzilla.css">
  <link rel="stylesheet" href="bundle.css">
  <script type="text/javascript" src="bundle.js" defer></script>
</head>
<body>

  <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-49796218-37', 'auto');
  ga('send', 'pageview');
  </script>

  <div class="book with-nav">
    <nav><div class="recipes-cover">
      <div id="tabzilla">
        <a href="https://www.mozilla.org/">Mozilla</a>
      </div>

      <ul class="recipes">
        <li><a href="/">Introduction</a></li>
        <li><a href="https://github.com/mozilla/serviceworker-cookbook/">Contribute on GitHub</a></li>

          
            <li class="category"><a href="caching-strategies.html">Caching strategies</a></li>
            
              
              <li>
                <a href="strategy-cache-and-update.html">
                  <span class="ball-difficulty-1" title="Difficulty: Beginner">
                    
                    B
                    
                  </span>
                  Cache and update
                </a>
              </li>
              
            
              
              <li>
                <a href="strategy-cache-only.html">
                  <span class="ball-difficulty-1" title="Difficulty: Beginner">
                    
                    B
                    
                  </span>
                  Cache only
                </a>
              </li>
              
            
              
              <li>
                <a href="strategy-network-or-cache.html">
                  <span class="ball-difficulty-1" title="Difficulty: Beginner">
                    
                    B
                    
                  </span>
                  Network or cache
                </a>
              </li>
              
            
              
              <li>
                <a href="strategy-cache-update-and-refresh.html">
                  <span class="ball-difficulty-2" title="Difficulty: Intermediate">
                    
                    I
                    
                  </span>
                  Cache, update and refresh
                </a>
              </li>
              
            
              
              <li>
                <a href="strategy-embedded-fallback.html">
                  <span class="ball-difficulty-2" title="Difficulty: Intermediate">
                    
                    I
                    
                  </span>
                  Embedded fallback
                </a>
              </li>
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
          
            <li class="category"><a href="web-push.html">Web Push</a></li>
            
              
            
              
            
              
            
              
            
              
            
              
              <li>
                <a href="push-get-payload.html">
                  <span class="ball-difficulty-1" title="Difficulty: Beginner">
                    
                    B
                    
                  </span>
                  Push and Retrieve Payload
                </a>
              </li>
              
            
              
              <li>
                <a href="push-payload.html">
                  <span class="ball-difficulty-1" title="Difficulty: Beginner">
                    
                    B
                    
                  </span>
                  Push Payload
                </a>
              </li>
              
            
              
              <li>
                <a href="push-rich.html">
                  <span class="ball-difficulty-1" title="Difficulty: Beginner">
                    
                    B
                    
                  </span>
                  Push Rich
                </a>
              </li>
              
            
              
              <li>
                <a href="push-simple.html">
                  <span class="ball-difficulty-1" title="Difficulty: Beginner">
                    
                    B
                    
                  </span>
                  Push Simple
                </a>
              </li>
              
            
              
              <li>
                <a href="push-replace.html">
                  <span class="ball-difficulty-2" title="Difficulty: Intermediate">
                    
                    I
                    
                  </span>
                  Push Tag
                </a>
              </li>
              
            
              
              <li>
                <a href="push-clients.html">
                  <span class="ball-difficulty-3" title="Difficulty: Advanced">
                    
                    A
                    
                  </span>
                  Push Clients
                </a>
              </li>
              
            
              
              <li>
                <a href="push-quota.html">
                  <span class="ball-difficulty-3" title="Difficulty: Advanced">
                    
                    A
                    
                  </span>
                  Push Quota
                </a>
              </li>
              
            
              
              <li>
                <a href="push-subscription-management.html">
                  <span class="ball-difficulty-3" title="Difficulty: Advanced">
                    
                    A
                    
                  </span>
                  Push Subscription
                </a>
              </li>
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
          
            <li class="category"><a href="general-usage.html">General Usage</a></li>
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
              <li>
                <a href="immediate-claim.html">
                  <span class="ball-difficulty-1" title="Difficulty: Beginner">
                    
                    B
                    
                  </span>
                  Immediate Claim
                </a>
              </li>
              
            
              
              <li>
                <a href="message-relay.html">
                  <span class="ball-difficulty-1" title="Difficulty: Beginner">
                    
                    B
                    
                  </span>
                  Message Relay
                </a>
              </li>
              
            
              
              <li>
                <a href="fetching.html">
                  <span class="ball-difficulty-2" title="Difficulty: Intermediate">
                    
                    I
                    
                  </span>
                  Fetching Remote Resources
                </a>
              </li>
              
            
              
              <li>
                <a href="live-flowchart.html">
                  <span class="ball-difficulty-3" title="Difficulty: Advanced">
                    
                    A
                    
                  </span>
                  Live Flowchart
                </a>
              </li>
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
          
            <li class="category"><a href="offline.html">Offline</a></li>
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
              <li>
                <a href="json-cache.html">
                  <span class="ball-difficulty-1" title="Difficulty: Beginner">
                    
                    B
                    
                  </span>
                  JSON Cache
                </a>
              </li>
              
            
              
              <li>
                <a href="offline-fallback.html">
                  <span class="ball-difficulty-1" title="Difficulty: Beginner">
                    
                    B
                    
                  </span>
                  Offline Fallback
                </a>
              </li>
              
            
              
              <li>
                <a href="offline-status.html">
                  <span class="ball-difficulty-1" title="Difficulty: Beginner">
                    
                    B
                    
                  </span>
                  Offline Status
                </a>
              </li>
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
          
            <li class="category"><a href="beyond-offline.html">Beyond Offline</a></li>
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
              <li>
                <a href="local-download.html">
                  <span class="ball-difficulty-1" title="Difficulty: Beginner">
                    
                    B
                    
                  </span>
                  Local Download
                </a>
              </li>
              
            
              
              <li>
                <a href="api-analytics.html">
                  <span class="ball-difficulty-2" title="Difficulty: Intermediate">
                    
                    I
                    
                  </span>
                  API Analytics
                </a>
              </li>
              
            
              
              <li>
                <a href="cache-from-zip.html">
                  <span class="ball-difficulty-2" title="Difficulty: Intermediate">
                    
                    I
                    
                  </span>
                  Cache from ZIP
                </a>
              </li>
              
            
              
              <li>
                <a href="load-balancer.html">
                  <span class="ball-difficulty-2" title="Difficulty: Intermediate">
                    
                    I
                    
                  </span>
                  Load balancer
                </a>
              </li>
              
            
              
              <li>
                <a href="virtual-server.html">
                  <span class="ball-difficulty-2" title="Difficulty: Intermediate">
                    
                    I
                    
                  </span>
                  Virtual Server
                </a>
              </li>
              
            
              
              <li>
                <a href="dependency-injector.html">
                  <span class="ball-difficulty-3" title="Difficulty: Advanced">
                    
                    A
                    
                  </span>
                  Dependency Injection
                </a>
              </li>
              
            
              
              <li>
                <a href="request-deferrer.html">
                  <span class="ball-difficulty-3" title="Difficulty: Advanced">
                    
                    A
                    
                  </span>
                  Request Deferrer
                </a>
              </li>
              
            
              
            
              
            
          
            <li class="category"><a href="performance.html">Performance</a></li>
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
              <li>
                <a href="cache-then-network.html">
                  <span class="ball-difficulty-1" title="Difficulty: Beginner">
                    
                    B
                    
                  </span>
                  Cache then Network
                </a>
              </li>
              
            
              
              <li>
                <a href="render-store.html">
                  <span class="ball-difficulty-2" title="Difficulty: Intermediate">
                    
                    I
                    
                  </span>
                  Render Store
                </a>
              </li>
              
            
          
      </ul>
    </div></nav>
    <main>
      <header>
        <div class="nav-top">
          <div class="item">
            <button id="navToggle" class="fi-list large"></button>
          </div>
          <div class="tabs">
            
              <div class="item"><a href="render-store.html">Readme</a></div>
              <div class="item"><a href="render-store_demo.html">Demo <button class="demo-launch" data-href="render-store/index.html"><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAwAAAAQCAQAAACIaFaMAAAAOklEQVR4AWMgA/yHQhBogPP+I0mgSYEJZgZG7BIQgGkUmnADEGKRaICw0Y1qQHEuNi+QJYEJ8UuQDACsJ1O3PKSOdQAAAABJRU5ErkJggg=="></button></a></div>
              <div class="item" style="flex-grow: 1;"></div>
              
                <div class="item"><a href="render-store_index_doc.html">index.js</a></div>
              
                <div class="item"><a href="render-store_pokemon_doc.html">pokemon.js</a></div>
              
                <div class="item"><a href="render-store_service-worker_doc.html">service-worker.js</a></div>
              
            
          </div>
        </div>
      </header>
      <div class="main-inner">
        <div id="container">
  <div id="background"></div>
  
  <ul class="sections">
      
        <li id="title">
            <div class="annotation">
                <h1>pokemon.js</h1>
            </div>
        </li>
      
      
      
      <li id="section-1">
          <div class="annotation">
            
            <div class="pilwrap ">
              <a class="pilcrow" href="#section-1">&#182;</a>
            </div>
            <p>Modern browsers prevent mixed content. I.e., if the page is served from
a safe (https) origin, they will block the content from other (non https)
origins. We use this service to tunnel Pokemon API responses through a
secure origin.</p>

          </div>
          
          <div class="content"><div class='highlight'><pre><span class="hljs-keyword">var</span> <span class="hljs-variable constant_">PROXY</span> = <span class="hljs-string">&#x27;https://crossorigin.me/&#x27;</span>;</pre></div></div>
          
      </li>
      
      
      <li id="section-2">
          <div class="annotation">
            
            <div class="pilwrap ">
              <a class="pilcrow" href="#section-2">&#182;</a>
            </div>
            <p>Some times we want to measure.</p>

          </div>
          
          <div class="content"><div class='highlight'><pre><span class="hljs-keyword">var</span> startTime = performance.<span class="hljs-title function_">now</span>();
<span class="hljs-keyword">var</span> interpolationTime = <span class="hljs-number">0</span>;
<span class="hljs-keyword">var</span> fetchingModelTime = <span class="hljs-number">0</span>;</pre></div></div>
          
      </li>
      
      
      <li id="section-3">
          <div class="annotation">
            
            <div class="pilwrap ">
              <a class="pilcrow" href="#section-3">&#182;</a>
            </div>
            <p>Here is the idea. This is the template for a Pokemon. It is
in charge of parsing which Pokemon is requested from the querystring
of the URL, fetch that pokemon and fill the template. Once the template
has been filled, we are going to mark the document as cached and send
to the render-store by sending the contents to the service worker.</p>

          </div>
          
      </li>
      
      
      <li id="section-4">
          <div class="annotation">
            
            <div class="pilwrap ">
              <a class="pilcrow" href="#section-4">&#182;</a>
            </div>
            <p>The cached mark is a simple <code>data-*</code> property in the document element.</p>

          </div>
          
          <div class="content"><div class='highlight'><pre><span class="hljs-keyword">var</span> isCached = <span class="hljs-variable language_">document</span>.<span class="hljs-property">documentElement</span>.<span class="hljs-property">dataset</span>.<span class="hljs-property">cached</span>;

<span class="hljs-keyword">if</span> (isCached) {</pre></div></div>
          
      </li>
      
      
      <li id="section-5">
          <div class="annotation">
            
            <div class="pilwrap ">
              <a class="pilcrow" href="#section-5">&#182;</a>
            </div>
            <p>If cached, log the times and we are done.</p>

          </div>
          
          <div class="content"><div class='highlight'><pre>  <span class="hljs-title function_">logTime</span>();
} <span class="hljs-keyword">else</span> {</pre></div></div>
          
      </li>
      
      
      <li id="section-6">
          <div class="annotation">
            
            <div class="pilwrap ">
              <a class="pilcrow" href="#section-6">&#182;</a>
            </div>
            <p>If not, fetch the pokemon info, fill the character sheet, log times and cache.</p>

          </div>
          
          <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">var</span> pokemonId = <span class="hljs-title function_">getPokemonId</span>();
  <span class="hljs-title function_">getPokemon</span>(pokemonId).<span class="hljs-title function_">then</span>(fillCharSheet).<span class="hljs-title function_">then</span>(logTime).<span class="hljs-title function_">then</span>(cache);
}</pre></div></div>
          
      </li>
      
      
      <li id="section-7">
          <div class="annotation">
            
            <div class="pilwrap ">
              <a class="pilcrow" href="#section-7">&#182;</a>
            </div>
            <p>Extract the pokemon id from the querystring.</p>

          </div>
          
          <div class="content"><div class='highlight'><pre><span class="hljs-keyword">function</span> <span class="hljs-title function_">getPokemonId</span>(<span class="hljs-params"></span>) {
  <span class="hljs-keyword">return</span> <span class="hljs-variable language_">window</span>.<span class="hljs-property">location</span>.<span class="hljs-property">search</span>.<span class="hljs-title function_">split</span>(<span class="hljs-string">&#x27;=&#x27;</span>)[<span class="hljs-number">1</span>];
}</pre></div></div>
          
      </li>
      
      
      <li id="section-8">
          <div class="annotation">
            
            <div class="pilwrap ">
              <a class="pilcrow" href="#section-8">&#182;</a>
            </div>
            <p>Fetch pokemon’s info as JSON.</p>

          </div>
          
          <div class="content"><div class='highlight'><pre><span class="hljs-keyword">function</span> <span class="hljs-title function_">getPokemon</span>(<span class="hljs-params">id</span>) {
  <span class="hljs-keyword">var</span> fetchingModelStart = performance.<span class="hljs-title function_">now</span>();
  <span class="hljs-keyword">var</span> url = <span class="hljs-variable constant_">PROXY</span> + <span class="hljs-string">&#x27;http://pokeapi.co/api/v1/pokemon/&#x27;</span> + id + <span class="hljs-string">&#x27;/?_b=&#x27;</span> + <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>();
  <span class="hljs-keyword">return</span> <span class="hljs-title function_">fetch</span>(url).<span class="hljs-title function_">then</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params">response</span>) {
    fetchingModelTime = performance.<span class="hljs-title function_">now</span>() - fetchingModelStart;
    <span class="hljs-keyword">return</span> response.<span class="hljs-title function_">json</span>();
  });
}</pre></div></div>
          
      </li>
      
      
      <li id="section-9">
          <div class="annotation">
            
            <div class="pilwrap ">
              <a class="pilcrow" href="#section-9">&#182;</a>
            </div>
            <p>Take the contents of the body as template and interpolate with
the pokemon info.</p>

          </div>
          
          <div class="content"><div class='highlight'><pre><span class="hljs-keyword">function</span> <span class="hljs-title function_">fillCharSheet</span>(<span class="hljs-params">pokemon</span>) {
  <span class="hljs-keyword">var</span> element = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">&#x27;body&#x27;</span>);
  element.<span class="hljs-property">innerHTML</span> = <span class="hljs-title function_">interpolateTemplate</span>(element.<span class="hljs-property">innerHTML</span>, pokemon);</pre></div></div>
          
      </li>
      
      
      <li id="section-10">
          <div class="annotation">
            
            <div class="pilwrap ">
              <a class="pilcrow" href="#section-10">&#182;</a>
            </div>
            <p>Specifically for the cookbook site :(</p>

          </div>
          
          <div class="content"><div class='highlight'><pre>  <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">&#x27;img&#x27;</span>).<span class="hljs-property">onload</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) {
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">window</span>.<span class="hljs-property">parent</span> === <span class="hljs-variable language_">window</span>) {
      <span class="hljs-keyword">return</span>;
    }
    <span class="hljs-variable language_">window</span>.<span class="hljs-property">parent</span>.<span class="hljs-property">document</span>.<span class="hljs-property">body</span>.<span class="hljs-title function_">dispatchEvent</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">CustomEvent</span>(<span class="hljs-string">&#x27;iframeresize&#x27;</span>));
  };
}</pre></div></div>
          
      </li>
      
      
      <li id="section-11">
          <div class="annotation">
            
            <div class="pilwrap ">
              <a class="pilcrow" href="#section-11">&#182;</a>
            </div>
            <p>Log times for interpolation, fetching and total loading times.</p>

          </div>
          
          <div class="content"><div class='highlight'><pre><span class="hljs-keyword">function</span> <span class="hljs-title function_">logTime</span>(<span class="hljs-params"></span>) {
  <span class="hljs-keyword">var</span> loadingTimeLabel = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">&#x27;#loading-time-label&#x27;</span>);
  <span class="hljs-keyword">var</span> interpolationTimeLabel =
    <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">&#x27;#interpolation-time-label&#x27;</span>);
  <span class="hljs-keyword">var</span> fetchingModelTimeLabel = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">&#x27;#fetching-time-label&#x27;</span>);
  loadingTimeLabel.<span class="hljs-property">textContent</span> = (performance.<span class="hljs-title function_">now</span>() - startTime) + <span class="hljs-string">&#x27; ms&#x27;</span>;
  interpolationTimeLabel.<span class="hljs-property">textContent</span> = interpolationTime + <span class="hljs-string">&#x27; ms&#x27;</span>;
  fetchingModelTimeLabel.<span class="hljs-property">textContent</span> = fetchingModelTime + <span class="hljs-string">&#x27; ms&#x27;</span>;
}</pre></div></div>
          
      </li>
      
      
      <li id="section-12">
          <div class="annotation">
            
            <div class="pilwrap ">
              <a class="pilcrow" href="#section-12">&#182;</a>
            </div>
            <p>Mark the documents as cached, then gets all the HTML content and send to
the service worker using a <code>PUT</code> request into <code>./render-store/</code> URL.
You could be wondering we need to send the URL for the cached content
but this info is implicitly added as the <code>referrer</code> property of the
request.</p>

          </div>
          
          <div class="content"><div class='highlight'><pre><span class="hljs-keyword">function</span> <span class="hljs-title function_">cache</span>(<span class="hljs-params"></span>) {
  <span class="hljs-variable language_">document</span>.<span class="hljs-property">documentElement</span>.<span class="hljs-property">dataset</span>.<span class="hljs-property">cached</span> = <span class="hljs-literal">true</span>;
  <span class="hljs-keyword">var</span> data = <span class="hljs-variable language_">document</span>.<span class="hljs-property">documentElement</span>.<span class="hljs-property">outerHTML</span>;
  <span class="hljs-title function_">fetch</span>(<span class="hljs-string">&#x27;./render-store/&#x27;</span>, { <span class="hljs-attr">method</span>: <span class="hljs-string">&#x27;PUT&#x27;</span>, <span class="hljs-attr">body</span>: data }).<span class="hljs-title function_">then</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;Page cached&#x27;</span>);
  });
}</pre></div></div>
          
      </li>
      
      
      <li id="section-13">
          <div class="annotation">
            
            <div class="pilwrap ">
              <a class="pilcrow" href="#section-13">&#182;</a>
            </div>
            <p>Look for <code>{{key}}</code> fragments inside the template and replace them with
the values of <code>pokemon[key]</code>.</p>

          </div>
          
          <div class="content"><div class='highlight'><pre><span class="hljs-keyword">function</span> <span class="hljs-title function_">interpolateTemplate</span>(<span class="hljs-params">template, pokemon</span>) {
  <span class="hljs-keyword">var</span> interpolationStart = performance.<span class="hljs-title function_">now</span>();
  <span class="hljs-keyword">var</span> result = template.<span class="hljs-title function_">replace</span>(<span class="hljs-regexp">/{{(\w+)}}/g</span>, <span class="hljs-keyword">function</span>(<span class="hljs-params">match, field</span>) {
    <span class="hljs-keyword">return</span> pokemon[field];
  });
  interpolationTime = performance.<span class="hljs-title function_">now</span>() - interpolationStart;
  <span class="hljs-keyword">return</span> result;
}</pre></div></div>
          
      </li>
      
  </ul>
</div>

        <hr/>
        <h2>Has it been useful?</h2>
       <p>Tell us what you think of this recipe by leaving a comment!</p>
        <aside id="disqus_thread"></aside>
        <script>
         // https://disqus.com/admin/universalcode/#configuration-variables
         var disqus_config = function () {
          this.page.identifier = 'render-store';
         };
         (function() { // DON'T EDIT BELOW THIS LINE
           var d = document, s = d.createElement('script');
           s.src = '//serviceworkers.disqus.com/embed.js';
           s.setAttribute('data-timestamp', +new Date());
           (d.head || d.body).appendChild(s);
         })();
        </script>
        <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
      </div>
    </main>
  </div>
</body>
</html>
