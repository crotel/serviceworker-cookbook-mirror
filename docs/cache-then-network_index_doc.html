<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1.0, user-scalable=yes">
  
  <title>Cache then Network Recipe - Performance - ServiceWorker Cookbook</title>
  
  <link rel="shortcut icon" href="favicon.ico" type="image/x-icon">
  <link rel="stylesheet" href="tabzilla.css">
  <link rel="stylesheet" href="bundle.css">
  <script type="text/javascript" src="bundle.js" defer></script>
</head>
<body>

  <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-49796218-37', 'auto');
  ga('send', 'pageview');
  </script>

  <div class="book with-nav">
    <nav><div class="recipes-cover">
      <div id="tabzilla">
        <a href="https://www.mozilla.org/">Mozilla</a>
      </div>

      <ul class="recipes">
        <li><a href="/">Introduction</a></li>
        <li><a href="https://github.com/mozilla/serviceworker-cookbook/">Contribute on GitHub</a></li>

          
            <li class="category"><a href="caching-strategies.html">Caching strategies</a></li>
            
              
              <li>
                <a href="strategy-cache-and-update.html">
                  <span class="ball-difficulty-1" title="Difficulty: Beginner">
                    
                    B
                    
                  </span>
                  Cache and update
                </a>
              </li>
              
            
              
              <li>
                <a href="strategy-cache-only.html">
                  <span class="ball-difficulty-1" title="Difficulty: Beginner">
                    
                    B
                    
                  </span>
                  Cache only
                </a>
              </li>
              
            
              
              <li>
                <a href="strategy-network-or-cache.html">
                  <span class="ball-difficulty-1" title="Difficulty: Beginner">
                    
                    B
                    
                  </span>
                  Network or cache
                </a>
              </li>
              
            
              
              <li>
                <a href="strategy-cache-update-and-refresh.html">
                  <span class="ball-difficulty-2" title="Difficulty: Intermediate">
                    
                    I
                    
                  </span>
                  Cache, update and refresh
                </a>
              </li>
              
            
              
              <li>
                <a href="strategy-embedded-fallback.html">
                  <span class="ball-difficulty-2" title="Difficulty: Intermediate">
                    
                    I
                    
                  </span>
                  Embedded fallback
                </a>
              </li>
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
          
            <li class="category"><a href="web-push.html">Web Push</a></li>
            
              
            
              
            
              
            
              
            
              
            
              
              <li>
                <a href="push-get-payload.html">
                  <span class="ball-difficulty-1" title="Difficulty: Beginner">
                    
                    B
                    
                  </span>
                  Push and Retrieve Payload
                </a>
              </li>
              
            
              
              <li>
                <a href="push-payload.html">
                  <span class="ball-difficulty-1" title="Difficulty: Beginner">
                    
                    B
                    
                  </span>
                  Push Payload
                </a>
              </li>
              
            
              
              <li>
                <a href="push-rich.html">
                  <span class="ball-difficulty-1" title="Difficulty: Beginner">
                    
                    B
                    
                  </span>
                  Push Rich
                </a>
              </li>
              
            
              
              <li>
                <a href="push-simple.html">
                  <span class="ball-difficulty-1" title="Difficulty: Beginner">
                    
                    B
                    
                  </span>
                  Push Simple
                </a>
              </li>
              
            
              
              <li>
                <a href="push-replace.html">
                  <span class="ball-difficulty-2" title="Difficulty: Intermediate">
                    
                    I
                    
                  </span>
                  Push Tag
                </a>
              </li>
              
            
              
              <li>
                <a href="push-clients.html">
                  <span class="ball-difficulty-3" title="Difficulty: Advanced">
                    
                    A
                    
                  </span>
                  Push Clients
                </a>
              </li>
              
            
              
              <li>
                <a href="push-quota.html">
                  <span class="ball-difficulty-3" title="Difficulty: Advanced">
                    
                    A
                    
                  </span>
                  Push Quota
                </a>
              </li>
              
            
              
              <li>
                <a href="push-subscription-management.html">
                  <span class="ball-difficulty-3" title="Difficulty: Advanced">
                    
                    A
                    
                  </span>
                  Push Subscription
                </a>
              </li>
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
          
            <li class="category"><a href="general-usage.html">General Usage</a></li>
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
              <li>
                <a href="immediate-claim.html">
                  <span class="ball-difficulty-1" title="Difficulty: Beginner">
                    
                    B
                    
                  </span>
                  Immediate Claim
                </a>
              </li>
              
            
              
              <li>
                <a href="message-relay.html">
                  <span class="ball-difficulty-1" title="Difficulty: Beginner">
                    
                    B
                    
                  </span>
                  Message Relay
                </a>
              </li>
              
            
              
              <li>
                <a href="fetching.html">
                  <span class="ball-difficulty-2" title="Difficulty: Intermediate">
                    
                    I
                    
                  </span>
                  Fetching Remote Resources
                </a>
              </li>
              
            
              
              <li>
                <a href="live-flowchart.html">
                  <span class="ball-difficulty-3" title="Difficulty: Advanced">
                    
                    A
                    
                  </span>
                  Live Flowchart
                </a>
              </li>
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
          
            <li class="category"><a href="offline.html">Offline</a></li>
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
              <li>
                <a href="json-cache.html">
                  <span class="ball-difficulty-1" title="Difficulty: Beginner">
                    
                    B
                    
                  </span>
                  JSON Cache
                </a>
              </li>
              
            
              
              <li>
                <a href="offline-fallback.html">
                  <span class="ball-difficulty-1" title="Difficulty: Beginner">
                    
                    B
                    
                  </span>
                  Offline Fallback
                </a>
              </li>
              
            
              
              <li>
                <a href="offline-status.html">
                  <span class="ball-difficulty-1" title="Difficulty: Beginner">
                    
                    B
                    
                  </span>
                  Offline Status
                </a>
              </li>
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
          
            <li class="category"><a href="beyond-offline.html">Beyond Offline</a></li>
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
              <li>
                <a href="local-download.html">
                  <span class="ball-difficulty-1" title="Difficulty: Beginner">
                    
                    B
                    
                  </span>
                  Local Download
                </a>
              </li>
              
            
              
              <li>
                <a href="api-analytics.html">
                  <span class="ball-difficulty-2" title="Difficulty: Intermediate">
                    
                    I
                    
                  </span>
                  API Analytics
                </a>
              </li>
              
            
              
              <li>
                <a href="cache-from-zip.html">
                  <span class="ball-difficulty-2" title="Difficulty: Intermediate">
                    
                    I
                    
                  </span>
                  Cache from ZIP
                </a>
              </li>
              
            
              
              <li>
                <a href="load-balancer.html">
                  <span class="ball-difficulty-2" title="Difficulty: Intermediate">
                    
                    I
                    
                  </span>
                  Load balancer
                </a>
              </li>
              
            
              
              <li>
                <a href="virtual-server.html">
                  <span class="ball-difficulty-2" title="Difficulty: Intermediate">
                    
                    I
                    
                  </span>
                  Virtual Server
                </a>
              </li>
              
            
              
              <li>
                <a href="dependency-injector.html">
                  <span class="ball-difficulty-3" title="Difficulty: Advanced">
                    
                    A
                    
                  </span>
                  Dependency Injection
                </a>
              </li>
              
            
              
              <li>
                <a href="request-deferrer.html">
                  <span class="ball-difficulty-3" title="Difficulty: Advanced">
                    
                    A
                    
                  </span>
                  Request Deferrer
                </a>
              </li>
              
            
              
            
              
            
          
            <li class="category"><a href="performance.html">Performance</a></li>
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
              <li>
                <a href="cache-then-network.html">
                  <span class="ball-difficulty-1" title="Difficulty: Beginner">
                    
                    B
                    
                  </span>
                  Cache then Network
                </a>
              </li>
              
            
              
              <li>
                <a href="render-store.html">
                  <span class="ball-difficulty-2" title="Difficulty: Intermediate">
                    
                    I
                    
                  </span>
                  Render Store
                </a>
              </li>
              
            
          
      </ul>
    </div></nav>
    <main>
      <header>
        <div class="nav-top">
          <div class="item">
            <button id="navToggle" class="fi-list large"></button>
          </div>
          <div class="tabs">
            
              <div class="item"><a href="cache-then-network.html">Readme</a></div>
              <div class="item"><a href="cache-then-network_demo.html">Demo <button class="demo-launch" data-href="cache-then-network/index.html"><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAwAAAAQCAQAAACIaFaMAAAAOklEQVR4AWMgA/yHQhBogPP+I0mgSYEJZgZG7BIQgGkUmnADEGKRaICw0Y1qQHEuNi+QJYEJ8UuQDACsJ1O3PKSOdQAAAABJRU5ErkJggg=="></button></a></div>
              <div class="item" style="flex-grow: 1;"></div>
              
                <div class="item"><a href="cache-then-network_index_doc.html">index.js</a></div>
              
            
          </div>
        </div>
      </header>
      <div class="main-inner">
        <div id="container">
  <div id="background"></div>
  
  <ul class="sections">
      
        <li id="title">
            <div class="annotation">
                <h1>index.js</h1>
            </div>
        </li>
      
      
      
      <li id="section-1">
          <div class="annotation">
            
            <div class="pilwrap ">
              <a class="pilcrow" href="#section-1">&#182;</a>
            </div>
            
          </div>
          
          <div class="content"><div class='highlight'><pre><span class="hljs-keyword">var</span> dataUrl = <span class="hljs-string">&#x27;https://api.github.com/events&#x27;</span>;
<span class="hljs-keyword">var</span> cacheDelayInput = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">&#x27;cache-delay&#x27;</span>);
<span class="hljs-keyword">var</span> cacheFailInput = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">&#x27;cache-fail&#x27;</span>);
<span class="hljs-keyword">var</span> networkDelayInput = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">&#x27;network-delay&#x27;</span>);
<span class="hljs-keyword">var</span> networkFailInput = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">&#x27;network-fail&#x27;</span>);
<span class="hljs-keyword">var</span> cacheStatus = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">&#x27;cache-status&#x27;</span>);
<span class="hljs-keyword">var</span> networkStatus = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">&#x27;network-status&#x27;</span>);
<span class="hljs-keyword">var</span> getDataButton = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">&#x27;getDataButton&#x27;</span>);
<span class="hljs-keyword">var</span> dataElement = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">&#x27;data&#x27;</span>);</pre></div></div>
          
      </li>
      
      
      <li id="section-2">
          <div class="annotation">
            
            <div class="pilwrap ">
              <a class="pilcrow" href="#section-2">&#182;</a>
            </div>
            <p>Caches are per-origin, so we need to pick a name that no
other page on this origin is going to try to use.</p>

          </div>
          
          <div class="content"><div class='highlight'><pre><span class="hljs-keyword">var</span> cacheName = <span class="hljs-string">&#x27;cache-then-network&#x27;</span>;</pre></div></div>
          
      </li>
      
      
      <li id="section-3">
          <div class="annotation">
            
            <div class="pilwrap ">
              <a class="pilcrow" href="#section-3">&#182;</a>
            </div>
            <p>If network data was received, we don’t want an in-flight cache
fetch to complete and overwrite the data that we just got from
the network. We use this flag to let the cache fetch callbacks
know whether a network fetch has already completed.</p>

          </div>
          
          <div class="content"><div class='highlight'><pre><span class="hljs-keyword">var</span> gotNetworkData = <span class="hljs-literal">false</span>;</pre></div></div>
          
      </li>
      
      
      <li id="section-4">
          <div class="annotation">
            
            <div class="pilwrap ">
              <a class="pilcrow" href="#section-4">&#182;</a>
            </div>
            <p>For showing elapsed times</p>

          </div>
          
          <div class="content"><div class='highlight'><pre><span class="hljs-keyword">var</span> networkFetchStartTime;
<span class="hljs-keyword">var</span> cacheFetchStartTime;</pre></div></div>
          
      </li>
      
      
      <li id="section-5">
          <div class="annotation">
            
            <div class="pilwrap ">
              <a class="pilcrow" href="#section-5">&#182;</a>
            </div>
            <p>UI functions</p>

          </div>
          
          <div class="content"><div class='highlight'><pre><span class="hljs-keyword">function</span> <span class="hljs-title function_">reset</span>(<span class="hljs-params"></span>) {
  dataElement.<span class="hljs-property">textContent</span> = <span class="hljs-string">&#x27;&#x27;</span>;
  cacheStatus.<span class="hljs-property">textContent</span> = <span class="hljs-string">&#x27;&#x27;</span>;
  networkStatus.<span class="hljs-property">textContent</span> = <span class="hljs-string">&#x27;&#x27;</span>;
  gotNetworkData = <span class="hljs-literal">false</span>;
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">disableUI</span>(<span class="hljs-params"></span>) {
  getDataButton.<span class="hljs-property">disabled</span> = <span class="hljs-literal">true</span>;
  cacheDelayInput.<span class="hljs-property">disabled</span> = <span class="hljs-literal">true</span>;
  cacheFailInput.<span class="hljs-property">disabled</span> = <span class="hljs-literal">true</span>;
  networkDelayInput.<span class="hljs-property">disabled</span> = <span class="hljs-literal">true</span>;
  networkFailInput.<span class="hljs-property">disabled</span> = <span class="hljs-literal">true</span>;
  <span class="hljs-title function_">reset</span>();
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">enableUI</span>(<span class="hljs-params"></span>) {
  getDataButton.<span class="hljs-property">disabled</span> = <span class="hljs-literal">false</span>;
  cacheDelayInput.<span class="hljs-property">disabled</span> = <span class="hljs-literal">false</span>;
  cacheFailInput.<span class="hljs-property">disabled</span> = <span class="hljs-literal">false</span>;
  networkDelayInput.<span class="hljs-property">disabled</span> = <span class="hljs-literal">false</span>;
  networkFailInput.<span class="hljs-property">disabled</span> = <span class="hljs-literal">false</span>;
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">updatePage</span>(<span class="hljs-params">data</span>) {
  dataElement.<span class="hljs-property">textContent</span> = <span class="hljs-string">&#x27;User &#x27;</span> + data[<span class="hljs-number">0</span>].<span class="hljs-property">actor</span>.<span class="hljs-property">login</span> +
                            <span class="hljs-string">&#x27; modified repo &#x27;</span> + data[<span class="hljs-number">0</span>].<span class="hljs-property">repo</span>.<span class="hljs-property">name</span>;
}</pre></div></div>
          
      </li>
      
      
      <li id="section-6">
          <div class="annotation">
            
            <div class="pilwrap ">
              <a class="pilcrow" href="#section-6">&#182;</a>
            </div>
            <p>Callbacks for network and cache fetches</p>

          </div>
          
          <div class="content"><div class='highlight'><pre><span class="hljs-keyword">function</span> <span class="hljs-title function_">handleFetchCompletion</span>(<span class="hljs-params">res</span>) {</pre></div></div>
          
      </li>
      
      
      <li id="section-7">
          <div class="annotation">
            
            <div class="pilwrap ">
              <a class="pilcrow" href="#section-7">&#182;</a>
            </div>
            <p>Simulate a network error by throwing in the callback</p>

          </div>
          
          <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">var</span> shouldNetworkError = networkFailInput.<span class="hljs-property">checked</span>;
  <span class="hljs-keyword">if</span> (shouldNetworkError) {
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">&#x27;Network error&#x27;</span>);
  }</pre></div></div>
          
      </li>
      
      
      <li id="section-8">
          <div class="annotation">
            
            <div class="pilwrap ">
              <a class="pilcrow" href="#section-8">&#182;</a>
            </div>
            <p>We have to clone the response here because request bodies
can only be read once. Placing a response in the cache
counts as a read and so does the <code>res.json</code> call below.</p>

          </div>
          
          <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">var</span> resClone = res.<span class="hljs-title function_">clone</span>();
  caches.<span class="hljs-title function_">open</span>(cacheName).<span class="hljs-title function_">then</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params">cache</span>) {</pre></div></div>
          
      </li>
      
      
      <li id="section-9">
          <div class="annotation">
            
            <div class="pilwrap ">
              <a class="pilcrow" href="#section-9">&#182;</a>
            </div>
            <p>Cache the response so that subsequent cache fetches
will find this updated data.</p>

          </div>
          
          <div class="content"><div class='highlight'><pre>    cache.<span class="hljs-title function_">put</span>(dataUrl, resClone);
  });</pre></div></div>
          
      </li>
      
      
      <li id="section-10">
          <div class="annotation">
            
            <div class="pilwrap ">
              <a class="pilcrow" href="#section-10">&#182;</a>
            </div>
            <p>Read the response as json</p>

          </div>
          
          <div class="content"><div class='highlight'><pre>  res.<span class="hljs-title function_">json</span>().<span class="hljs-title function_">then</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params">data</span>) {
    <span class="hljs-title function_">updatePage</span>(data);</pre></div></div>
          
      </li>
      
      
      <li id="section-11">
          <div class="annotation">
            
            <div class="pilwrap ">
              <a class="pilcrow" href="#section-11">&#182;</a>
            </div>
            <p>Make sure that any in-flight cache requests don’t
overwrite the information that we just received.</p>

          </div>
          
          <div class="content"><div class='highlight'><pre>    gotNetworkData = <span class="hljs-literal">true</span>;
  });
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">handleCacheFetchCompletion</span>(<span class="hljs-params">res</span>) {
  <span class="hljs-keyword">var</span> shouldCacheError = cacheFailInput.<span class="hljs-property">checked</span>;
  <span class="hljs-keyword">if</span> (shouldCacheError || !res) {
    <span class="hljs-keyword">throw</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">&#x27;Cache miss&#x27;</span>);
  }</pre></div></div>
          
      </li>
      
      
      <li id="section-12">
          <div class="annotation">
            
            <div class="pilwrap ">
              <a class="pilcrow" href="#section-12">&#182;</a>
            </div>
            <p>Read the response as json</p>

          </div>
          
          <div class="content"><div class='highlight'><pre>  res.<span class="hljs-title function_">json</span>().<span class="hljs-title function_">then</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params">data</span>) {</pre></div></div>
          
      </li>
      
      
      <li id="section-13">
          <div class="annotation">
            
            <div class="pilwrap ">
              <a class="pilcrow" href="#section-13">&#182;</a>
            </div>
            <p>Only update the page if the network request hasn’t
already returned. Otherwise we’d be overwriting the
data we just pulled from the network.</p>

          </div>
          
          <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> (!gotNetworkData) {
      <span class="hljs-title function_">updatePage</span>(data);
    }
  });
}</pre></div></div>
          
      </li>
      
      
      <li id="section-14">
          <div class="annotation">
            
            <div class="pilwrap ">
              <a class="pilcrow" href="#section-14">&#182;</a>
            </div>
            <p>This is the heart of the demo. Whenever the user clicks the
button, we’ll make simultaneous (or nearly-simultaneous) requests
of the cache and the network for data. In a real application, this
would probably happen on page load rather than as a result of
user action, but to make the page more illustrative and allow
for user-specified delays, we’ve got a button.</p>

          </div>
          
          <div class="content"><div class='highlight'><pre>getDataButton.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">&#x27;click&#x27;</span>, <span class="hljs-keyword">function</span> <span class="hljs-title function_">handleClick</span>(<span class="hljs-params"></span>) {
  <span class="hljs-title function_">disableUI</span>();</pre></div></div>
          
      </li>
      
      
      <li id="section-15">
          <div class="annotation">
            
            <div class="pilwrap ">
              <a class="pilcrow" href="#section-15">&#182;</a>
            </div>
            <p>Initiate network fetch</p>

          </div>
          
          <div class="content"><div class='highlight'><pre>  networkStatus.<span class="hljs-property">textContent</span> = <span class="hljs-string">&#x27;Fetching...&#x27;</span>;
  networkFetchStartTime = <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>();</pre></div></div>
          
      </li>
      
      
      <li id="section-16">
          <div class="annotation">
            
            <div class="pilwrap ">
              <a class="pilcrow" href="#section-16">&#182;</a>
            </div>
            <p>Use the Fetch API to actually request data</p>
<p>It should not be necessary to use a cache busting URL param
because we’re using the ‘no-cache’ caching option in the fetch
call, but those caching options are not yet implemented
in Firefox or Chrome. See bug 1120715 for the Firefox
implementation status.</p>

          </div>
          
          <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">var</span> cacheBuster = <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>();
  <span class="hljs-keyword">var</span> networkFetch = <span class="hljs-title function_">fetch</span>(dataUrl + <span class="hljs-string">&#x27;?cacheBuster=&#x27;</span> + cacheBuster, {
    <span class="hljs-attr">mode</span>: <span class="hljs-string">&#x27;cors&#x27;</span>,
    <span class="hljs-attr">cache</span>: <span class="hljs-string">&#x27;no-cache&#x27;</span>,
  }).<span class="hljs-title function_">then</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params">res</span>) {
    <span class="hljs-keyword">var</span> networkDelay = networkDelayInput.<span class="hljs-property">value</span> || <span class="hljs-number">0</span>;</pre></div></div>
          
      </li>
      
      
      <li id="section-17">
          <div class="annotation">
            
            <div class="pilwrap ">
              <a class="pilcrow" href="#section-17">&#182;</a>
            </div>
            <p>We simulate network delays by waiting before actually calling
our network fetch callback. If the callback errors, we want
to make sure to reject the Promise we got from the original
fetch.</p>

          </div>
          
          <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params">resolve, reject</span>) {
      <span class="hljs-built_in">setTimeout</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) {
        <span class="hljs-keyword">try</span> {
          <span class="hljs-title function_">handleFetchCompletion</span>(res);
          <span class="hljs-title function_">resolve</span>();
        } <span class="hljs-keyword">catch</span> (err) {
          <span class="hljs-title function_">reject</span>(err);
        }
      }, networkDelay);
    });
  }).<span class="hljs-title function_">then</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) {
    <span class="hljs-keyword">var</span> now = <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>();
    <span class="hljs-keyword">var</span> elapsed = now - networkFetchStartTime;
    networkStatus.<span class="hljs-property">textContent</span> = <span class="hljs-string">&#x27;Success after &#x27;</span> + elapsed + <span class="hljs-string">&#x27;ms&#x27;</span>;
  }).<span class="hljs-title function_">catch</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params">err</span>) {
    <span class="hljs-keyword">var</span> now = <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>();
    <span class="hljs-keyword">var</span> elapsed = now - networkFetchStartTime;
    networkStatus.<span class="hljs-property">textContent</span> = err + <span class="hljs-string">&#x27; after &#x27;</span> + elapsed + <span class="hljs-string">&#x27;ms&#x27;</span>;
  });</pre></div></div>
          
      </li>
      
      
      <li id="section-18">
          <div class="annotation">
            
            <div class="pilwrap ">
              <a class="pilcrow" href="#section-18">&#182;</a>
            </div>
            <p>Get cached data</p>

          </div>
          
          <div class="content"><div class='highlight'><pre>  cacheStatus.<span class="hljs-property">textContent</span> = <span class="hljs-string">&#x27;Fetching...&#x27;</span>;
  cacheFetchStartTime = <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>();
  <span class="hljs-keyword">var</span> cacheFetch = caches.<span class="hljs-title function_">open</span>(cacheName).<span class="hljs-title function_">then</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params">cache</span>) {
    <span class="hljs-keyword">return</span> cache.<span class="hljs-title function_">match</span>(dataUrl).<span class="hljs-title function_">then</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params">res</span>) {
      <span class="hljs-keyword">var</span> cacheDelay = cacheDelayInput.<span class="hljs-property">value</span> || <span class="hljs-number">0</span>;</pre></div></div>
          
      </li>
      
      
      <li id="section-19">
          <div class="annotation">
            
            <div class="pilwrap ">
              <a class="pilcrow" href="#section-19">&#182;</a>
            </div>
            <p>We simulate cache delays by waiting before actually calling
our cache fetch callback. If the callback errors, we want
to make sure to reject the Promise we got from the original
call to <code>match</code>.</p>

          </div>
          
          <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params">resolve, reject</span>) {
        <span class="hljs-built_in">setTimeout</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) {
          <span class="hljs-keyword">try</span> {
            <span class="hljs-title function_">handleCacheFetchCompletion</span>(res);
            <span class="hljs-title function_">resolve</span>();
          } <span class="hljs-keyword">catch</span> (err) {
            <span class="hljs-title function_">reject</span>(err);
          }
        }, cacheDelay);
      });
    }).<span class="hljs-title function_">then</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) {
      <span class="hljs-keyword">var</span> now = <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>();
      <span class="hljs-keyword">var</span> elapsed = now - cacheFetchStartTime;
      cacheStatus.<span class="hljs-property">textContent</span> = <span class="hljs-string">&#x27;Success after &#x27;</span> + elapsed + <span class="hljs-string">&#x27;ms&#x27;</span>;
    }).<span class="hljs-title function_">catch</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params">err</span>) {
      <span class="hljs-keyword">var</span> now = <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>();
      <span class="hljs-keyword">var</span> elapsed = now - cacheFetchStartTime;
      cacheStatus.<span class="hljs-property">textContent</span> = err + <span class="hljs-string">&#x27; after &#x27;</span> + elapsed + <span class="hljs-string">&#x27;ms&#x27;</span>;
    });
  });

  <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">all</span>([networkFetch, cacheFetch]).<span class="hljs-title function_">then</span>(enableUI);
});</pre></div></div>
          
      </li>
      
  </ul>
</div>

        <hr/>
        <h2>Has it been useful?</h2>
       <p>Tell us what you think of this recipe by leaving a comment!</p>
        <aside id="disqus_thread"></aside>
        <script>
         // https://disqus.com/admin/universalcode/#configuration-variables
         var disqus_config = function () {
          this.page.identifier = 'cache-then-network';
         };
         (function() { // DON'T EDIT BELOW THIS LINE
           var d = document, s = d.createElement('script');
           s.src = '//serviceworkers.disqus.com/embed.js';
           s.setAttribute('data-timestamp', +new Date());
           (d.head || d.body).appendChild(s);
         })();
        </script>
        <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
      </div>
    </main>
  </div>
</body>
</html>
