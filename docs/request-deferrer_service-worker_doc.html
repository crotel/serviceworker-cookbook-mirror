<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1.0, user-scalable=yes">
  
  <title>Request Deferrer Recipe - Beyond Offline - ServiceWorker Cookbook</title>
  
  <link rel="shortcut icon" href="favicon.ico" type="image/x-icon">
  <link rel="stylesheet" href="tabzilla.css">
  <link rel="stylesheet" href="bundle.css">
  <script type="text/javascript" src="bundle.js" defer></script>
</head>
<body>

  <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-49796218-37', 'auto');
  ga('send', 'pageview');
  </script>

  <div class="book with-nav">
    <nav><div class="recipes-cover">
      <div id="tabzilla">
        <a href="https://www.mozilla.org/">Mozilla</a>
      </div>

      <ul class="recipes">
        <li><a href="/">Introduction</a></li>
        <li><a href="https://github.com/mozilla/serviceworker-cookbook/">Contribute on GitHub</a></li>

          
            <li class="category"><a href="caching-strategies.html">Caching strategies</a></li>
            
              
              <li>
                <a href="strategy-cache-and-update.html">
                  <span class="ball-difficulty-1" title="Difficulty: Beginner">
                    
                    B
                    
                  </span>
                  Cache and update
                </a>
              </li>
              
            
              
              <li>
                <a href="strategy-cache-only.html">
                  <span class="ball-difficulty-1" title="Difficulty: Beginner">
                    
                    B
                    
                  </span>
                  Cache only
                </a>
              </li>
              
            
              
              <li>
                <a href="strategy-network-or-cache.html">
                  <span class="ball-difficulty-1" title="Difficulty: Beginner">
                    
                    B
                    
                  </span>
                  Network or cache
                </a>
              </li>
              
            
              
              <li>
                <a href="strategy-cache-update-and-refresh.html">
                  <span class="ball-difficulty-2" title="Difficulty: Intermediate">
                    
                    I
                    
                  </span>
                  Cache, update and refresh
                </a>
              </li>
              
            
              
              <li>
                <a href="strategy-embedded-fallback.html">
                  <span class="ball-difficulty-2" title="Difficulty: Intermediate">
                    
                    I
                    
                  </span>
                  Embedded fallback
                </a>
              </li>
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
          
            <li class="category"><a href="web-push.html">Web Push</a></li>
            
              
            
              
            
              
            
              
            
              
            
              
              <li>
                <a href="push-get-payload.html">
                  <span class="ball-difficulty-1" title="Difficulty: Beginner">
                    
                    B
                    
                  </span>
                  Push and Retrieve Payload
                </a>
              </li>
              
            
              
              <li>
                <a href="push-payload.html">
                  <span class="ball-difficulty-1" title="Difficulty: Beginner">
                    
                    B
                    
                  </span>
                  Push Payload
                </a>
              </li>
              
            
              
              <li>
                <a href="push-rich.html">
                  <span class="ball-difficulty-1" title="Difficulty: Beginner">
                    
                    B
                    
                  </span>
                  Push Rich
                </a>
              </li>
              
            
              
              <li>
                <a href="push-simple.html">
                  <span class="ball-difficulty-1" title="Difficulty: Beginner">
                    
                    B
                    
                  </span>
                  Push Simple
                </a>
              </li>
              
            
              
              <li>
                <a href="push-replace.html">
                  <span class="ball-difficulty-2" title="Difficulty: Intermediate">
                    
                    I
                    
                  </span>
                  Push Tag
                </a>
              </li>
              
            
              
              <li>
                <a href="push-clients.html">
                  <span class="ball-difficulty-3" title="Difficulty: Advanced">
                    
                    A
                    
                  </span>
                  Push Clients
                </a>
              </li>
              
            
              
              <li>
                <a href="push-quota.html">
                  <span class="ball-difficulty-3" title="Difficulty: Advanced">
                    
                    A
                    
                  </span>
                  Push Quota
                </a>
              </li>
              
            
              
              <li>
                <a href="push-subscription-management.html">
                  <span class="ball-difficulty-3" title="Difficulty: Advanced">
                    
                    A
                    
                  </span>
                  Push Subscription
                </a>
              </li>
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
          
            <li class="category"><a href="general-usage.html">General Usage</a></li>
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
              <li>
                <a href="immediate-claim.html">
                  <span class="ball-difficulty-1" title="Difficulty: Beginner">
                    
                    B
                    
                  </span>
                  Immediate Claim
                </a>
              </li>
              
            
              
              <li>
                <a href="message-relay.html">
                  <span class="ball-difficulty-1" title="Difficulty: Beginner">
                    
                    B
                    
                  </span>
                  Message Relay
                </a>
              </li>
              
            
              
              <li>
                <a href="fetching.html">
                  <span class="ball-difficulty-2" title="Difficulty: Intermediate">
                    
                    I
                    
                  </span>
                  Fetching Remote Resources
                </a>
              </li>
              
            
              
              <li>
                <a href="live-flowchart.html">
                  <span class="ball-difficulty-3" title="Difficulty: Advanced">
                    
                    A
                    
                  </span>
                  Live Flowchart
                </a>
              </li>
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
          
            <li class="category"><a href="offline.html">Offline</a></li>
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
              <li>
                <a href="json-cache.html">
                  <span class="ball-difficulty-1" title="Difficulty: Beginner">
                    
                    B
                    
                  </span>
                  JSON Cache
                </a>
              </li>
              
            
              
              <li>
                <a href="offline-fallback.html">
                  <span class="ball-difficulty-1" title="Difficulty: Beginner">
                    
                    B
                    
                  </span>
                  Offline Fallback
                </a>
              </li>
              
            
              
              <li>
                <a href="offline-status.html">
                  <span class="ball-difficulty-1" title="Difficulty: Beginner">
                    
                    B
                    
                  </span>
                  Offline Status
                </a>
              </li>
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
          
            <li class="category"><a href="beyond-offline.html">Beyond Offline</a></li>
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
              <li>
                <a href="local-download.html">
                  <span class="ball-difficulty-1" title="Difficulty: Beginner">
                    
                    B
                    
                  </span>
                  Local Download
                </a>
              </li>
              
            
              
              <li>
                <a href="api-analytics.html">
                  <span class="ball-difficulty-2" title="Difficulty: Intermediate">
                    
                    I
                    
                  </span>
                  API Analytics
                </a>
              </li>
              
            
              
              <li>
                <a href="cache-from-zip.html">
                  <span class="ball-difficulty-2" title="Difficulty: Intermediate">
                    
                    I
                    
                  </span>
                  Cache from ZIP
                </a>
              </li>
              
            
              
              <li>
                <a href="load-balancer.html">
                  <span class="ball-difficulty-2" title="Difficulty: Intermediate">
                    
                    I
                    
                  </span>
                  Load balancer
                </a>
              </li>
              
            
              
              <li>
                <a href="virtual-server.html">
                  <span class="ball-difficulty-2" title="Difficulty: Intermediate">
                    
                    I
                    
                  </span>
                  Virtual Server
                </a>
              </li>
              
            
              
              <li>
                <a href="dependency-injector.html">
                  <span class="ball-difficulty-3" title="Difficulty: Advanced">
                    
                    A
                    
                  </span>
                  Dependency Injection
                </a>
              </li>
              
            
              
              <li>
                <a href="request-deferrer.html">
                  <span class="ball-difficulty-3" title="Difficulty: Advanced">
                    
                    A
                    
                  </span>
                  Request Deferrer
                </a>
              </li>
              
            
              
            
              
            
          
            <li class="category"><a href="performance.html">Performance</a></li>
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
            
              
              <li>
                <a href="cache-then-network.html">
                  <span class="ball-difficulty-1" title="Difficulty: Beginner">
                    
                    B
                    
                  </span>
                  Cache then Network
                </a>
              </li>
              
            
              
              <li>
                <a href="render-store.html">
                  <span class="ball-difficulty-2" title="Difficulty: Intermediate">
                    
                    I
                    
                  </span>
                  Render Store
                </a>
              </li>
              
            
          
      </ul>
    </div></nav>
    <main>
      <header>
        <div class="nav-top">
          <div class="item">
            <button id="navToggle" class="fi-list large"></button>
          </div>
          <div class="tabs">
            
              <div class="item"><a href="request-deferrer.html">Readme</a></div>
              <div class="item"><a href="request-deferrer_demo.html">Demo <button class="demo-launch" data-href="request-deferrer/index.html"><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAwAAAAQCAQAAACIaFaMAAAAOklEQVR4AWMgA/yHQhBogPP+I0mgSYEJZgZG7BIQgGkUmnADEGKRaICw0Y1qQHEuNi+QJYEJ8UuQDACsJ1O3PKSOdQAAAABJRU5ErkJggg=="></button></a></div>
              <div class="item" style="flex-grow: 1;"></div>
              
                <div class="item"><a href="request-deferrer_index_doc.html">index.js</a></div>
              
                <div class="item"><a href="request-deferrer_server_doc.html">server.js</a></div>
              
                <div class="item"><a href="request-deferrer_service-worker_doc.html">service-worker.js</a></div>
              
            
          </div>
        </div>
      </header>
      <div class="main-inner">
        <div id="container">
  <div id="background"></div>
  
  <ul class="sections">
      
        <li id="title">
            <div class="annotation">
                <h1>service-worker.js</h1>
            </div>
        </li>
      
      
      
      <li id="section-1">
          <div class="annotation">
            
            <div class="pilwrap ">
              <a class="pilcrow" href="#section-1">&#182;</a>
            </div>
            
          </div>
          
          <div class="content"><div class='highlight'><pre><span class="hljs-comment">/* eslint-env es6 */</span>
<span class="hljs-comment">/* eslint no-unused-vars: 0 */</span>
<span class="hljs-comment">/* global importScripts, ServiceWorkerWare, localforage */</span>
importScripts(<span class="hljs-string">&#x27;./lib/ServiceWorkerWare.js&#x27;</span>);
importScripts(<span class="hljs-string">&#x27;./lib/localforage.js&#x27;</span>);</pre></div></div>
          
      </li>
      
      
      <li id="section-2">
          <div class="annotation">
            
            <div class="pilwrap ">
              <a class="pilcrow" href="#section-2">&#182;</a>
            </div>
            <p>Determine the root for the routes. I.e, if the Service Worker URL is
<code>http://example.com/path/to/sw.js</code>, then the root is
<code>http://example.com/path/to/</code></p>

          </div>
          
          <div class="content"><div class='highlight'><pre><span class="hljs-keyword">var</span> root = (<span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) {
  <span class="hljs-keyword">var</span> tokens = (self.<span class="hljs-property">location</span> + <span class="hljs-string">&#x27;&#x27;</span>).<span class="hljs-title function_">split</span>(<span class="hljs-string">&#x27;/&#x27;</span>);
  tokens[tokens.<span class="hljs-property">length</span> - <span class="hljs-number">1</span>] = <span class="hljs-string">&#x27;&#x27;</span>;
  <span class="hljs-keyword">return</span> tokens.<span class="hljs-title function_">join</span>(<span class="hljs-string">&#x27;/&#x27;</span>);
})();</pre></div></div>
          
      </li>
      
      
      <li id="section-3">
          <div class="annotation">
            
            <div class="pilwrap ">
              <a class="pilcrow" href="#section-3">&#182;</a>
            </div>
            <p>By using Mozilla’s ServiceWorkerWare we can quickly setup some routes
for a <em>virtual server</em>. <strong>It is convenient you review the
<a href="/virtual-server.html">virtual server recipe</a> before seeing this</strong>.</p>

          </div>
          
          <div class="content"><div class='highlight'><pre><span class="hljs-keyword">var</span> worker = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ServiceWorkerWare</span>();</pre></div></div>
          
      </li>
      
      
      <li id="section-4">
          <div class="annotation">
            
            <div class="pilwrap ">
              <a class="pilcrow" href="#section-4">&#182;</a>
            </div>
            <p>So here is the idea. We will check if we are online or not. In case
we are not online, enqueue the request and provide a fake response.
Else, flush the queue and let the new request to reach the network.</p>

          </div>
          
      </li>
      
      
      <li id="section-5">
          <div class="annotation">
            
            <div class="pilwrap ">
              <a class="pilcrow" href="#section-5">&#182;</a>
            </div>
            <p>This function factory does exactly that.</p>

          </div>
          
          <div class="content"><div class='highlight'><pre><span class="hljs-keyword">function</span> <span class="hljs-title function_">tryOrFallback</span>(<span class="hljs-params">fakeResponse</span>) {</pre></div></div>
          
      </li>
      
      
      <li id="section-6">
          <div class="annotation">
            
            <div class="pilwrap ">
              <a class="pilcrow" href="#section-6">&#182;</a>
            </div>
            <p>Return a handler that…</p>

          </div>
          
          <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">return</span> <span class="hljs-keyword">function</span>(<span class="hljs-params">req, res</span>) {</pre></div></div>
          
      </li>
      
      
      <li id="section-7">
          <div class="annotation">
            
            <div class="pilwrap ">
              <a class="pilcrow" href="#section-7">&#182;</a>
            </div>
            <p>If offline, enqueue and answer with the fake response.</p>

          </div>
          
          <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> (!navigator.<span class="hljs-property">onLine</span>) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;No network availability, enqueuing&#x27;</span>);
      <span class="hljs-keyword">return</span> <span class="hljs-title function_">enqueue</span>(req).<span class="hljs-title function_">then</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) {</pre></div></div>
          
      </li>
      
      
      <li id="section-8">
          <div class="annotation">
            
            <div class="pilwrap ">
              <a class="pilcrow" href="#section-8">&#182;</a>
            </div>
            <p>As the fake response will be reused but Response objects
are one use only, we need to clone it each time we use it.</p>

          </div>
          
          <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">return</span> fakeResponse.<span class="hljs-title function_">clone</span>();
      });
    }</pre></div></div>
          
      </li>
      
      
      <li id="section-9">
          <div class="annotation">
            
            <div class="pilwrap ">
              <a class="pilcrow" href="#section-9">&#182;</a>
            </div>
            <p>If online, flush the queue and answer from network.</p>

          </div>
          
          <div class="content"><div class='highlight'><pre>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;Network available! Flushing queue.&#x27;</span>);
    <span class="hljs-keyword">return</span> <span class="hljs-title function_">flushQueue</span>().<span class="hljs-title function_">then</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) {
      <span class="hljs-keyword">return</span> <span class="hljs-title function_">fetch</span>(req);
    });
  };
}</pre></div></div>
          
      </li>
      
      
      <li id="section-10">
          <div class="annotation">
            
            <div class="pilwrap ">
              <a class="pilcrow" href="#section-10">&#182;</a>
            </div>
            <p>A fake response with a joke for when there is no connection. A real
implementation could have cached the last collection of quotations
and keep a local model. For simplicity, not implemented here.</p>

          </div>
          
          <div class="content"><div class='highlight'><pre>worker.<span class="hljs-title function_">get</span>(root + <span class="hljs-string">&#x27;api/quotations?*&#x27;</span>, <span class="hljs-title function_">tryOrFallback</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Response</span>(
  <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>([{
    <span class="hljs-attr">text</span>: <span class="hljs-string">&#x27;You are offline and I know it well.&#x27;</span>,
    <span class="hljs-attr">author</span>: <span class="hljs-string">&#x27;The Service Worker Cookbook&#x27;</span>,
    <span class="hljs-attr">id</span>: <span class="hljs-number">1</span>,
    <span class="hljs-attr">isSticky</span>: <span class="hljs-literal">true</span>
  }]),
  { <span class="hljs-attr">headers</span>: { <span class="hljs-string">&#x27;Content-Type&#x27;</span>: <span class="hljs-string">&#x27;application/json&#x27;</span> } }
)));</pre></div></div>
          
      </li>
      
      
      <li id="section-11">
          <div class="annotation">
            
            <div class="pilwrap ">
              <a class="pilcrow" href="#section-11">&#182;</a>
            </div>
            <p>For deletion, let’s simulate that all went OK. <strong>Notice we are omitting
the body of the response</strong>. Trying to add a body with a 204, deleted, as
status throws an error.</p>

          </div>
          
          <div class="content"><div class='highlight'><pre>worker.<span class="hljs-title function_">delete</span>(root + <span class="hljs-string">&#x27;api/quotations/:id?*&#x27;</span>, <span class="hljs-title function_">tryOrFallback</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Response</span>({
  <span class="hljs-attr">status</span>: <span class="hljs-number">204</span>
})));</pre></div></div>
          
      </li>
      
      
      <li id="section-12">
          <div class="annotation">
            
            <div class="pilwrap ">
              <a class="pilcrow" href="#section-12">&#182;</a>
            </div>
            <p>Creation is another story. We can not reach the server so we can not
get the id for the new quotations. No problem, just say we accept the
creation and we will process it later, as soon as we recover connectivity.</p>

          </div>
          
          <div class="content"><div class='highlight'><pre>worker.<span class="hljs-title function_">post</span>(root + <span class="hljs-string">&#x27;api/quotations?*&#x27;</span>, <span class="hljs-title function_">tryOrFallback</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Response</span>(<span class="hljs-literal">null</span>, {
  <span class="hljs-attr">status</span>: <span class="hljs-number">202</span>
})));</pre></div></div>
          
      </li>
      
      
      <li id="section-13">
          <div class="annotation">
            
            <div class="pilwrap ">
              <a class="pilcrow" href="#section-13">&#182;</a>
            </div>
            <p>Start the service worker.</p>

          </div>
          
          <div class="content"><div class='highlight'><pre>worker.<span class="hljs-title function_">init</span>();</pre></div></div>
          
      </li>
      
      
      <li id="section-14">
          <div class="annotation">
            
            <div class="pilwrap ">
              <a class="pilcrow" href="#section-14">&#182;</a>
            </div>
            <p>By using Mozilla’s localforage db wrapper, we can count on
a fast setup for a versatile key-value database. We use
it to store queue of deferred requests.</p>

          </div>
          
      </li>
      
      
      <li id="section-15">
          <div class="annotation">
            
            <div class="pilwrap ">
              <a class="pilcrow" href="#section-15">&#182;</a>
            </div>
            <p>Enqueue consists of adding a request to the list. Due to the
limitations of IndexedDB, Request and Response objects can not
be saved so we need an alternative representations. This is
why we call to <code>serialize()</code>.`</p>

          </div>
          
          <div class="content"><div class='highlight'><pre><span class="hljs-keyword">function</span> <span class="hljs-title function_">enqueue</span>(<span class="hljs-params">request</span>) {
  <span class="hljs-keyword">return</span> <span class="hljs-title function_">serialize</span>(request).<span class="hljs-title function_">then</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params">serialized</span>) {
    localforage.<span class="hljs-title function_">getItem</span>(<span class="hljs-string">&#x27;queue&#x27;</span>).<span class="hljs-title function_">then</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params">queue</span>) {
      <span class="hljs-comment">/* eslint no-param-reassign: 0 */</span>
      queue = queue || [];
      queue.<span class="hljs-title function_">push</span>(serialized);
      <span class="hljs-keyword">return</span> localforage.<span class="hljs-title function_">setItem</span>(<span class="hljs-string">&#x27;queue&#x27;</span>, queue).<span class="hljs-title function_">then</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(serialized.<span class="hljs-property">method</span>, serialized.<span class="hljs-property">url</span>, <span class="hljs-string">&#x27;enqueued!&#x27;</span>);
      });
    });
  });
}</pre></div></div>
          
      </li>
      
      
      <li id="section-16">
          <div class="annotation">
            
            <div class="pilwrap ">
              <a class="pilcrow" href="#section-16">&#182;</a>
            </div>
            <p>Flush is a little more complicated. It consists of getting
the elements of the queue in order and sending each one,
keeping track of not yet sent request. Before sending a request
we need to recreate it from the alternative representation
stored in IndexedDB.</p>

          </div>
          
          <div class="content"><div class='highlight'><pre><span class="hljs-keyword">function</span> <span class="hljs-title function_">flushQueue</span>(<span class="hljs-params"></span>) {</pre></div></div>
          
      </li>
      
      
      <li id="section-17">
          <div class="annotation">
            
            <div class="pilwrap ">
              <a class="pilcrow" href="#section-17">&#182;</a>
            </div>
            <p>Get the queue</p>

          </div>
          
          <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">return</span> localforage.<span class="hljs-title function_">getItem</span>(<span class="hljs-string">&#x27;queue&#x27;</span>).<span class="hljs-title function_">then</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params">queue</span>) {
    <span class="hljs-comment">/* eslint no-param-reassign: 0 */</span>
    queue = queue || [];</pre></div></div>
          
      </li>
      
      
      <li id="section-18">
          <div class="annotation">
            
            <div class="pilwrap ">
              <a class="pilcrow" href="#section-18">&#182;</a>
            </div>
            <p>If empty, nothing to do!</p>

          </div>
          
          <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> (!queue.<span class="hljs-property">length</span>) {
      <span class="hljs-keyword">return</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">resolve</span>();
    }</pre></div></div>
          
      </li>
      
      
      <li id="section-19">
          <div class="annotation">
            
            <div class="pilwrap ">
              <a class="pilcrow" href="#section-19">&#182;</a>
            </div>
            <p>Else, send the requests in order…</p>

          </div>
          
          <div class="content"><div class='highlight'><pre>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;Sending &#x27;</span>, queue.<span class="hljs-property">length</span>, <span class="hljs-string">&#x27; requests...&#x27;</span>);
    <span class="hljs-keyword">return</span> <span class="hljs-title function_">sendInOrder</span>(queue).<span class="hljs-title function_">then</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) {</pre></div></div>
          
      </li>
      
      
      <li id="section-20">
          <div class="annotation">
            
            <div class="pilwrap ">
              <a class="pilcrow" href="#section-20">&#182;</a>
            </div>
            <p><strong>Requires error handling</strong>. Actually, this is assuming all the requests
in queue are a success when reaching the Network. So it should empty the
queue step by step, only popping from the queue if the request completes
with success.</p>

          </div>
          
          <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">return</span> localforage.<span class="hljs-title function_">setItem</span>(<span class="hljs-string">&#x27;queue&#x27;</span>, []);
    });
  });
}</pre></div></div>
          
      </li>
      
      
      <li id="section-21">
          <div class="annotation">
            
            <div class="pilwrap ">
              <a class="pilcrow" href="#section-21">&#182;</a>
            </div>
            <p>Send the requests inside the queue in order. Waiting for the current before
sending the next one.</p>

          </div>
          
          <div class="content"><div class='highlight'><pre><span class="hljs-keyword">function</span> <span class="hljs-title function_">sendInOrder</span>(<span class="hljs-params">requests</span>) {</pre></div></div>
          
      </li>
      
      
      <li id="section-22">
          <div class="annotation">
            
            <div class="pilwrap ">
              <a class="pilcrow" href="#section-22">&#182;</a>
            </div>
            <p>The <code>reduce()</code> chains one promise per serialized request, not allowing to
progress to the next one until completing the current.</p>

          </div>
          
          <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">var</span> sending = requests.<span class="hljs-title function_">reduce</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params">prevPromise, serialized</span>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&#x27;Sending&#x27;</span>, serialized.<span class="hljs-property">method</span>, serialized.<span class="hljs-property">url</span>);
    <span class="hljs-keyword">return</span> prevPromise.<span class="hljs-title function_">then</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) {
      <span class="hljs-keyword">return</span> <span class="hljs-title function_">deserialize</span>(serialized).<span class="hljs-title function_">then</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params">request</span>) {
        <span class="hljs-keyword">return</span> <span class="hljs-title function_">fetch</span>(request);
      });
    });
  }, <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">resolve</span>());
  <span class="hljs-keyword">return</span> sending;
}</pre></div></div>
          
      </li>
      
      
      <li id="section-23">
          <div class="annotation">
            
            <div class="pilwrap ">
              <a class="pilcrow" href="#section-23">&#182;</a>
            </div>
            <p>Serialize is a little bit convolved due to headers is not a simple object.</p>

          </div>
          
          <div class="content"><div class='highlight'><pre><span class="hljs-keyword">function</span> <span class="hljs-title function_">serialize</span>(<span class="hljs-params">request</span>) {
  <span class="hljs-keyword">var</span> headers = {};</pre></div></div>
          
      </li>
      
      
      <li id="section-24">
          <div class="annotation">
            
            <div class="pilwrap ">
              <a class="pilcrow" href="#section-24">&#182;</a>
            </div>
            <p><code>for(... of ...)</code> is ES6 notation but current browsers supporting SW, support this
notation as well and this is the only way of retrieving all the headers.</p>

          </div>
          
          <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> entry <span class="hljs-keyword">of</span> request.<span class="hljs-property">headers</span>.<span class="hljs-title function_">entries</span>()) {
    headers[entry[<span class="hljs-number">0</span>]] = entry[<span class="hljs-number">1</span>];
  }
  <span class="hljs-keyword">var</span> serialized = {
    <span class="hljs-attr">url</span>: request.<span class="hljs-property">url</span>,
    <span class="hljs-attr">headers</span>: headers,
    <span class="hljs-attr">method</span>: request.<span class="hljs-property">method</span>,
    <span class="hljs-attr">mode</span>: request.<span class="hljs-property">mode</span>,
    <span class="hljs-attr">credentials</span>: request.<span class="hljs-property">credentials</span>,
    <span class="hljs-attr">cache</span>: request.<span class="hljs-property">cache</span>,
    <span class="hljs-attr">redirect</span>: request.<span class="hljs-property">redirect</span>,
    <span class="hljs-attr">referrer</span>: request.<span class="hljs-property">referrer</span>
  };</pre></div></div>
          
      </li>
      
      
      <li id="section-25">
          <div class="annotation">
            
            <div class="pilwrap ">
              <a class="pilcrow" href="#section-25">&#182;</a>
            </div>
            <p>Only if method is not <code>GET</code> or <code>HEAD</code> is the request allowed to have body.</p>

          </div>
          
          <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">if</span> (request.<span class="hljs-property">method</span> !== <span class="hljs-string">&#x27;GET&#x27;</span> &amp;&amp; request.<span class="hljs-property">method</span> !== <span class="hljs-string">&#x27;HEAD&#x27;</span>) {
    <span class="hljs-keyword">return</span> request.<span class="hljs-title function_">clone</span>().<span class="hljs-title function_">text</span>().<span class="hljs-title function_">then</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params">body</span>) {
      serialized.<span class="hljs-property">body</span> = body;
      <span class="hljs-keyword">return</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">resolve</span>(serialized);
    });
  }
  <span class="hljs-keyword">return</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">resolve</span>(serialized);
}</pre></div></div>
          
      </li>
      
      
      <li id="section-26">
          <div class="annotation">
            
            <div class="pilwrap ">
              <a class="pilcrow" href="#section-26">&#182;</a>
            </div>
            <p>Compared, deserialize is pretty simple.</p>

          </div>
          
          <div class="content"><div class='highlight'><pre><span class="hljs-keyword">function</span> <span class="hljs-title function_">deserialize</span>(<span class="hljs-params">data</span>) {
  <span class="hljs-keyword">return</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">resolve</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Request</span>(data.<span class="hljs-property">url</span>, data));
}</pre></div></div>
          
      </li>
      
  </ul>
</div>

        <hr/>
        <h2>Has it been useful?</h2>
       <p>Tell us what you think of this recipe by leaving a comment!</p>
        <aside id="disqus_thread"></aside>
        <script>
         // https://disqus.com/admin/universalcode/#configuration-variables
         var disqus_config = function () {
          this.page.identifier = 'request-deferrer';
         };
         (function() { // DON'T EDIT BELOW THIS LINE
           var d = document, s = d.createElement('script');
           s.src = '//serviceworkers.disqus.com/embed.js';
           s.setAttribute('data-timestamp', +new Date());
           (d.head || d.body).appendChild(s);
         })();
        </script>
        <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
      </div>
    </main>
  </div>
</body>
</html>
